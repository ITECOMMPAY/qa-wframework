# qa-wframework

Это пример нашего фреймворка для тестирования веб-приложений.

Он пока не пригоден для удобного использования за рамками наших проектов и выложен здесь, как сопроводительный материал для доклада на SQA Days 27.

## Установка

* Фреймворк работает только под GNU/Linux
* Для его работы требуется PHP 7.2 или выше, composer и бинарные расширения PHP (в одних дистрибутивах они ставятся отдельными пакетами, в других - вкомпилированы в PHP, в третьих - нужно самому собрать): ext-curl, ext-dom, ext-imagick, ext-json, ext-libxml, ext-mbstring, ext-pcre, ext-phar, ext-posix, ext-simplexml, ext-tokenizer, ext-xml, ext-xmlwriter, ext-zip
* В корне где лежит composer.json нужно выполнить composer install

## Краткое описание фреймворка 

Фреймворк лежит в каталоге ./common/Module/WFramework

Он состоит из 5 модулей, которые находятся в каталоге Modules:
* WebTestingModule - главный модуль фреймворка, который расширяет WebDriver модуль Codeception. Для его работы необходимы остальные четыре модуля.
* SeleniumServerModule - модуль для автоматической настройки и запуска Selenium Server
* LoggerModule - модуль логирования
* ShotsStorageModule - модуль для сохранения скриншотов элементов в S3
* WebAssertsModule - модуль, который пока просто оборачивает проверки Codeception

Фреймворк состоит из нескольких слоёв.

### Первый слой 

предоставляет стабильный программный интерфейс к нестабильному интерфейсу приложения.

Делает он это с помощью PageObject'ов и AliasMap'ов.

PageObject'ы делятся на Блоки (WBlock) и Элементы (WElement).

Блоки: 
* просто описывают некоторый кусок страницы
* существуют в единственном экземпляре, как и кусок страницы, который они описывают
* не содержат никакой сложной логики - вся их логика снаружи, в тестах

Элементы:
* описывают кнопки, поля ввода, календари, таблицы и т.п. элементы страницы
* существуют во множестве экземпляров, каждый из которых имеет свой локатор
* содержат в себе сложную логику, но для тестов предоставляют простой и понятный интерфейс

Блоки состоят из Элементов. Элементы состоят из других элементов. 

Все вместе они собраны в дерево через шаблон Composite. Элемент вычисляет свой локатор, относительно родительского Блока или Элемента.

Блоки и Элементы имеют единый интерфейс, который реализован в классе WPageObject. В частности, этот интерфейс содержит is и should методы. is-методы проверяют заданное условие для PageObject'а и возвращают true или false. should-методы ожидают выполнения условия в течение некоторого таймаута. 

AliasMap'ы - это двухсторонние ассоциативные массивы, где по ключу можно получить значение, а по значению - ключ.
Ключами у нас выступают псевдонимы надписей, а значениями - реальные надписи на странице.

Везде по тестам у нас передаются псевдонимы, а реальные значения извлекаются из AliasMap только в месте непосредственного использования.
Таким образом мы отвязываем наши тесты от реальных надписей на странице.

### Второй слой

описывает шаги тестов.

Шаги тестов у нас лежат в виде методов в отдельных StepObject'ах, а тесты собираются из шагов. Помимо шагов в StepObject'ах так же лежат ссылки на блоки, которые этим шагам необходимы.

StepObject'ы связаны друг-с-другом через FluentInterface. Каждый шаг возвращает StepObject в котором находится, если шаги этого StepObject'а всё ещё актуальны для текущей конфигурации страницы, или другой более подходящий StepObject.

Таким образом нам не нужно ломать голову над тем какой StepObject сейчас актуален, после какого шага он потеряет актуальность и все его методы начнут падать с ошибками, а так же какой StepObject нужно использовать далее.  

Для передачи значений между шагами используется синглтон TestProperties. Так же он служит для централизованного хранения всех тестовых данных и настроек.

## Описание примера тестов

Тестовый проект лежит в каталоге ./tests

Настройки проекта находятся в файле cases.suite.yml

Пример теста находится в файле cases/exampleCest.php

Тест представляет собой последовательность шагов.

Шаги лежат в StepObject'ах в каталоге _support/Helper/TestSteps

Шаги содержат в себе ссылки на Блоки. Блоки лежат в каталоге _support/Helper/Blocks

Блоки состоят из элементов. Общие элементы фреймворка лежат в каталоге ./common/Module/WFramework/WebObjects/Primitive. Элементы, индивидуальные для тестового проекта лежат в каталоге _support/Helper/Elements

Помимо тестового примера в каталоге cases находятся файлы storeShotsCest.php и selfCheckCest.php. storeShotsCest.php - загружает скриншоты элементов в S3. selfCheckCest.php - перебирает все блоки проекта и валидирует их локаторы.

В остальном, тестовый проект представляет собой обычный проект на Codeception.
